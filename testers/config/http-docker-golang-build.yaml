commands:
  - cmd: "httptool"
    args: ["serve", "--address", "0.0.0.0:8081"]
    restartTries: 0
  - cmd: "./bin/events-bridge"
    env:
      EB_CONFIG_CONTENT: |
        source:
          type: http
          options:
            address: ":8080"
            method: "POST"
            path: "/build"
            buffer: 10
            multipart: true

        runners:
          # Docker runner per estrarre, testare e compilare il progetto Go
          - type: docker
            options:
              image: "golang:1.23-alpine"
              pull_policy: "IfNotPresent"
              working_dir: "/workspace"
              mount_path: "/workspace"
              commands:
                - "sh"
                - "-c"
                - |
                  set -e
                  echo "=== Extracting project files ==="
                  if [ -f /workspace/*.tar.gz ]; then
                    tar -xzf /workspace/*.tar.gz -C /workspace/
                    rm /workspace/*.tar.gz
                  elif [ -f /workspace/*.zip ]; then
                    unzip -q /workspace/*.zip -d /workspace/
                    rm /workspace/*.zip
                  fi
                  
                  echo "=== Project structure ==="
                  ls -la /workspace/
                  
                  echo "=== Running tests ==="
                  go test -v ./...
                  
                  echo "=== Building binary ==="
                  go build -o /workspace/app -ldflags="-s -w" .
                  
                  echo "=== Binary info ==="
                  ls -lh /workspace/app
                  file /workspace/app
                  
                  echo "=== Build completed successfully ==="
              env:
                - "CGO_ENABLED=0"
                - "GOOS=linux"
                - "GOARCH=amd64"
              timeout: "300s"
              network_mode: "bridge"
              capture_output: true
              output_to_metadata: true
              metadata_key_prefix: "build_"
              fail_on_non_zero: true
              artifacts:
                - container_path: "/workspace/app"
                  metadata_key: "binary"
                  compress: true
              cap_drop:
                - "ALL"
              read_only_rootfs: false

          # HTTP runner per inviare il binario e i log di build
          - type: http
            options:
              url: "http://localhost:8081/binary"
              method: POST
              timeout: 30s
              headers:
                Content-Type: "application/gzip"
                X-Build-Status: "{{build_exit_code}}"
                X-Binary-Name: "app"
              body_from_metadata: "binary"
              decode_base64: true

          # HTTP runner separato per inviare i log di build
          - type: http
            options:
              url: "http://localhost:8081/logs"
              method: POST
              timeout: 10s
              headers:
                Content-Type: "text/plain"
              body: |
                Build Exit Code: {{build_exit_code}}
                
                === STDOUT ===
                {{build_stdout}}
                
                === STDERR ===
                {{build_stderr}}
    args: []
    restartTries: 0
  - cmd: "httptool"
    args:
      [
        "send",
        "--path",
        "/build",
        "--payload-file",
        "./testers/tools/sample-go-project.tar.gz",
        "--interval",
        "15s",
        "--content-type",
        "application/gzip",
      ]
    restartTries: 0
killOthers: true
