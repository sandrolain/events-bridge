commands:
  - name: "http-out"
    cmd: "httptool"
    args: ["serve", "--address", "0.0.0.0:8081"]
    restartTries: 0
  - cmd: "./bin/events-bridge"
    env:
      EB_CONFIG_CONTENT: |
        source:
          type: http
          options:
            address: ":8080"
            method: "POST"
            path: "/build"
            buffer: 10
            multipart: true
            timeout: 20s

        runners:
          # Docker runner per build e test del progetto Go
          - type: docker
            options:
              image: "golang:1.23-alpine"
              commands:
                - "sh"
                - "-c"
                - |
                  cd /workspace &&
                  echo "=== Listing workspace ===" &&
                  ls -lah &&
                  echo "=== Extracting project ===" &&
                  tar -xzf *.tar.gz 2>/dev/null || true &&
                  ls -lah &&
                  echo "=== Running tests ===" &&
                  go test -v ./... &&
                  echo "=== Building binary ===" &&
                  go build -o /workspace/app -ldflags="-s -w" . &&
                  echo "=== Build completed successfully ===" &&
                  ls -lh /workspace/app
              env:
                - "CGO_ENABLED=0"
                - "GOOS=linux"
                - "GOARCH=amd64"
              timeout: "300s"
              artifacts:
                - containerPath: "/workspace/app"
                  compress: true
              capDrop:
                - "ALL"

          # HTTP runner per inviare il binario compilato
          - type: http
            options:
              url: "http://localhost:8081/binary"
              timeout: 30s
              headers:
                Content-Type: "application/octet-stream"
    args: []
    restartTries: 0
  - name: "http-in"
    cmd: "httptool"
    args:
      [
        "send",
        "--path",
        "/build",
        "--file",
        "project=./testers/tools/sample-go-project.tar.gz",
        "--interval",
        "5s",
      ]
    restartTries: 0
killOthers: true
